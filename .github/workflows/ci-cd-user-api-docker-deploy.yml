name: Service CI/CD Pipeline for User API (Docker + Deploy)

on:
  push:
    branches:
      - test/user-api

env:
  project-directory: ./apps/user

jobs:
  build-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18.x"
          
      - name: Enable Corepack & Yarn 4
        run: |
          corepack enable
          corepack prepare yarn@4.9.4 --activate
          yarn --version

      - name: Install dependencies
        working-directory: ${{ env.project-directory }}
        run: yarn install --immutable

      - name: Build application
        working-directory: ${{ env.project-directory }}
        run: yarn build

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.project-directory }}/Dockerfile
          push: true
          tags: greenstand/treetracker-wallet-app:test-user-api

  deploy:
    name: Deploy to Dev Environment
    runs-on: ubuntu-latest
    needs: build-docker
    if: |
      !contains(github.event.head_commit.message, 'skip ci') &&
      !contains(github.event.head_commit.message, 'skip-ci') &&
      github.repository == 'Greenstand/treetracker-wallet-app'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash

      - name: Update Docker image and add test suffix
        run: |
          cd apps/user/deployment/base
          # Add -test suffix to all resource names
          kustomize edit set nameSuffix test
          kustomize edit set image greenstand/treetracker-wallet-app=greenstand/treetracker-wallet-app:test-user-api

      - name: Install doctl (DigitalOcean CLI)
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DEV_DIGITALOCEAN_TOKEN }}

      - name: Save kubeconfig for DigitalOcean cluster
        run: |
          doctl kubernetes cluster kubeconfig save ${{ secrets.DEV_CLUSTER_NAME }}

      - name: Ensure namespace exists
        run: |
          kubectl get namespace ${{ secrets.K8S_NAMESPACE }} \
          || kubectl create namespace ${{ secrets.K8S_NAMESPACE }}
          
      - name: Deploy to Kubernetes
        run: |
          kustomize build apps/user/deployment/overlays/development \
          | kubectl apply --wait -f -
          
      - name: Wait for API pods to be ready
        run: |
          NAMESPACE="${{ secrets.K8S_NAMESPACE }}"
          kubectl wait --for=condition=ready pod -l app=user-api -n "$NAMESPACE" --timeout=180s

      - name: Get deployed URL
        run: |
          NAMESPACE="${{ secrets.K8S_NAMESPACE }}"
          HOST=$(kubectl get svc -n ambassador ambassador -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          PREFIX=$(kubectl get mapping treetracker-wallet-monorepo-user-api -n "$NAMESPACE" -o jsonpath='{.spec.prefix}')
          URL="http://$HOST$PREFIX"
          echo "âœ… Deployed URL: $URL"
          echo "DEPLOYED_URL=$URL" >> $GITHUB_ENV

