name: Service CI/CD Pipeline for User API (Docker + Semantic Release + Deploy)

on:
  push:
    branches:
      - test/user-api-build-ci
    paths:
      - 'apps/user/**'
      - 'packages/**'
      - 'package.json'
      - 'yarn.lock'
      - '.yarnrc.yml'
      - '.yarn/**'

env:
  project-directory: ./apps/user

jobs:
  release-and-build:
    name: Semantic Release + Docker Build
    runs-on: ubuntu-latest
    outputs:
      bumped_version: ${{ steps.export_bumped_version.outputs.bumped_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Enable Corepack & Yarn 4
        run: |
          corepack enable
          corepack prepare yarn@4.9.4 --activate

      - name: Install dependencies
        working-directory: ${{ env.project-directory }}
        run: yarn install --immutable

      - name: Run semantic-release
        run: npx semantic-release
        working-directory: ${{ env.project-directory }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get released version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@master
        with:
          working-directory: ${{ env.project-directory }}

      - name: Export bumped version
        id: export_bumped_version
        run: |
          echo "BUMPED_VERSION=${{ steps.package-version.outputs.current-version }}"
          echo "::set-output name=bumped_version::${{ steps.package-version.outputs.current-version }}"

      - name: Build application
        working-directory: ${{ env.project-directory }}
        run: yarn build

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.project-directory }}/Dockerfile
          push: true
          tags: greenstand/treetracker-wallet-app:${{ steps.package-version.outputs.current-version }}

  deploy:
    name: Deploy to Dev Environment
    runs-on: ubuntu-latest
    needs: release-and-build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kustomize
        run: curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash

      - name: Update Docker image in kustomize
        run: |
          cd apps/user/deployment/base
          kustomize edit set image greenstand/treetracker-wallet-app:${{ needs.release-and-build.outputs.bumped_version }}

      - name: Install doctl for Kubernetes
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DEV_DIGITALOCEAN_TOKEN }}

      - name: Save kubeconfig for DigitalOcean cluster
        run: doctl kubernetes cluster kubeconfig save ${{ secrets.DEV_CLUSTER_NAME }}

      - name: Deploy Kubernetes resources
        run: kustomize build apps/user/deployment/overlays/development | kubectl apply -n ${{ secrets.K8S_NAMESPACE }} --wait -f -
