name: Deploy

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to Deploy'
        required: true
        type: string
      env:
        type: choice
        description: "Deployment Environment"
        options:
          - dev
          - test
          - prod
        default: 'dev'

env:
  PROJECT_DIRECTORY: ./apps/web
  REPOSITORY: 'Greenstand/treetracker-wallet-app'
  NODE_VERSION: "20.x"
  ENVIRONMENT: ${{ inputs.environment }} 
  DEV_URL: https://wallet-dev.treetracker.org
  TEST_URL: https://wallet-test.treetracker.org
  PROD_URL: https://wallet.treetracker.org
  # AWS Setup Required
  DEV_CDN_S3_BUCKET: ${{ secrets.DEV_CDN_S3_BUCKET }}
  DEV_CDN_DISTRIBUTION_ID: ${{ secrets.DEV_CDN_DISTRIBUTION_ID }}
  TEST_CDN_S3_BUCKET: ${{ secrets.TEST_CDN_S3_BUCKET }}
  TEST_CDN_DISTRIBUTION_ID: ${{ secrets.TEST_CDN_DISTRIBUTION_ID }}
  PROD_CDN_S3_BUCKET: ${{ secrets.PROD_CDN_S3_BUCKET }}
  PROD_CDN_DISTRIBUTION_ID: ${{ secrets.PROD_CDN_DISTRIBUTION_ID }}

permissions:
  contents: read

jobs:
  build:
    name: Build Next.js Static Site
    runs-on: ubuntu-latest
    if: (github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Enable Corepack 
        run: |
          corepack enable
          corepack prepare yarn@4.9.4 --activate

      - name: Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION}}

      - name: Install Dependencies
        run: yarn install --immutable

      - name: Set Environment Variables for Build
        run: |
         case "$ENVIRONMENT" in
          dev)
           echo "DEPLOYMENT_HOSTNAME=$DEV_URL" > ${{ env.PROJECT_DIRECTORY }}/.env.production
           ;;
          test)
           echo "DEPLOYMENT_HOSTNAME=$TEST_URL" > ${{ env.PROJECT_DIRECTORY }}/.env.production
           ;;
          prod)
           echo "DEPLOYMENT_HOSTNAME=$PROD_URL" > ${{ env.PROJECT_DIRECTORY }}/.env.production
           ;;
         esac
         echo "Generated .env.production:"
         cat ${{ env.PROJECT_DIRECTORY }}/.env.production


      - name: Build Static Site
        run: |
          cd ${{ env.PROJECT_DIRECTORY }}
          yarn build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: static-site-build
          path: ${{ env.PROJECT_DIRECTORY }}/out
          retention-days: 1
  
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [build]
    if: github.repository == REPOSITORY
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: static-site-build
          path: build/
    
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
    
      - name: Set S3 Bucket and CloudFront ID
        run: |
          case "$ENVIRONMENT" in
           dev)
            echo "S3_BUCKET=$DEV_CDN_S3_BUCKET" >> $GITHUB_ENV
            echo "DISTRIBUTION_ID=$DEV_CDN_DISTRIBUTION_ID" >> $GITHUB_ENV
            ;;
           test)
            echo "S3_BUCKET=$TEST_CDN_S3_BUCKET" >> $GITHUB_ENV
            echo "DISTRIBUTION_ID=$TEST_CDN_DISTRIBUTION_ID" >> $GITHUB_ENV
            ;;
           prod)
            echo "S3_BUCKET=$PROD_CDN_S3_BUCKET" >> $GITHUB_ENV
            echo "DISTRIBUTION_ID=$PROD_CDN_DISTRIBUTION_ID" >> $GITHUB_ENV
            ;;
          esac

      - name: Deploy to S3 Bucket
        run: aws s3 sync build/ s3://$S3_BUCKET/ --delete

      - name: Invalidate CloudFront Cache
        run: aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"

      - name: Deployment Complete
        run: |
         case "$ENVIRONMENT" in
          dev)
           echo "::notice title=Deployment Complete::Website deployed to $DEPLOYMENT_HOSTNAME"
           ;;
          test)
           echo "::notice title=Deployment Complete::Website deployed to $DEPLOYMENT_HOSTNAME"
           ;;
          prod)
           echo "::notice title=Deployment Complete::Website deployed to $DEPLOYMENT_HOSTNAME"
           ;;
         esac
