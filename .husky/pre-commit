# .husky/pre-commit
#!/bin/bash

echo "üîç Running lint-staged..."
yarn lint-staged || exit 1

# Get list of staged files, handle spaces/special chars
TMPFILE=$(mktemp)
git diff --cached --name-only -z > "$TMPFILE"
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "üîÅ Running tests on branch: $CURRENT_BRANCH"

# Flags for changes (use null delimiter)
WEB_CHANGED=false
USER_CHANGED=false
while IFS= read -r -d '' file; do
  case "$file" in
    apps/web/*)
      WEB_CHANGED=true
      ;;
    apps/user/*)
      USER_CHANGED=true
      ;;
  esac
done < "$TMPFILE"
rm -f "$TMPFILE"

FAILED=0

if [ "$WEB_CHANGED" = true ]; then
  echo "üß™ Detected changes in apps/web ‚Äî running Cypress tests"
  yarn workspace web cy:component || FAILED=1
  yarn workspace web cy:e2e-headless  || FAILED=1
fi

if [ "$USER_CHANGED" = true ]; then
  echo "üß™ Detected changes in apps/user ‚Äî running e2e tests"
  yarn workspace user test:unit || FAILED=1
  yarn workspace user test || FAILED=1
  yarn workspace user test:e2e || FAILED=1
  yarn workspace user int-test || FAILED=1
fi

if [ "$WEB_CHANGED" = false ] && [ "$USER_CHANGED" = false ]; then
  echo "‚úÖ No changes in apps/web or apps/user ‚Äî skipping tests"
fi

if [ "$FAILED" -ne 0 ]; then
  echo "‚ùå One or more tests failed ‚Äî commit aborted"
  exit 1
fi

echo "‚úÖ All tests passed ‚Äî continuing with commit"
exit 0

